@page "/sharding/partitioning"
@using System.Globalization
@rendermode InteractiveServer

@inject ShardingApiClient ShardingApi

<PageTitle>PostgreSQL –ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ</PageTitle>

<h1>Demo 1: PostgreSQL Native Partitioning</h1>

<p>
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ hash-–ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏—è PostgreSQL.
    –¢–∞–±–ª–∏—Ü–∞ <code>users_partitioned</code> —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ 4 –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ <code>HASH(id)</code>.
    PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç <code>INSERT</code>/<code>SELECT</code> –≤ –Ω—É–∂–Ω—É—é –ø–∞—Ä—Ç–∏—Ü–∏—é.
</p>

<div class="mb-3">
    <div class="btn-group" role="group">
        <button class="btn btn-primary" @onclick="InitAsync" disabled="@_isLoading">
            üèóÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏
        </button>
        <button class="btn btn-success" @onclick="SeedAsync" disabled="@_isLoading">
            üå± –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏ (@_seedCount —à—Ç.)
        </button>
        <button class="btn btn-info" @onclick="GetStatsAsync" disabled="@_isLoading">
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button class="btn btn-danger" @onclick="ResetAsync" disabled="@_isLoading">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
        </button>
    </div>
</div>

<div class="mb-3">
    <label for="seedCount" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</label>
    <input id="seedCount" type="number" class="form-control" style="max-width: 200px" @bind="_seedCount" min="1"
           max="500" />
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é</strong>
    </div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="addEmail" class="form-label">Email:</label>
                <input id="addEmail" type="email" class="form-control" style="max-width: 300px"
                       @bind="_addEmail" placeholder="user@example.com" />
            </div>
            <div class="col-auto">
                <label for="addRole" class="form-label">–†–æ–ª—å:</label>
                <select id="addRole" class="form-select" style="max-width: 200px" @bind="_addRole">
                    <option value="client">client</option>
                    <option value="tutor">tutor</option>
                    <option value="admin">admin</option>
                    <option value="super_admin">super_admin</option>
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-success" @onclick="AddUserAsync" disabled="@_isLoading">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
}

@if (_shardData is not null && _shardData.Partitions.Count > 0)
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>üì¶ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º</strong>
            <span class="badge bg-secondary">–í—Å–µ–≥–æ: @_shardData.TotalRows –∑–∞–ø–∏—Å–µ–π</span>
        </div>
        <div class="card-body">
            <div class="row">
                @{
                    var colors = new[] { "primary", "success", "warning", "info" };
                }
                @foreach (var (partition, index) in _shardData.Partitions.Select((p, i) => (p, i)))
                {
                    var color = colors[index % colors.Length];
                    var percentage = _shardData.TotalRows > 0
                        ? (double)partition.RowCount / _shardData.TotalRows * 100
                        : 0;

                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card border-@color h-100">
                            <div
                                class="card-header bg-@color bg-opacity-10 d-flex justify-content-between align-items-center">
                                <strong>üóÑÔ∏è @partition.PartitionName</strong>
                                <span class="badge bg-@color">@partition.RowCount</span>
                            </div>
                            <div class="card-body p-2">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-@color" role="progressbar"
                                         style="width: @percentage.ToString("F1", CultureInfo.InvariantCulture)%"
                                         aria-valuenow="@partition.RowCount" aria-valuemin="0"
                                         aria-valuemax="@_shardData.TotalRows">
                                    </div>
                                </div>
                                <small class="text-muted">@percentage.ToString("F1")% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞</small>

                                @if (partition.Users.Count > 0)
                                {
                                    <div class="table-responsive mt-2" style="max-height: 250px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Email</th>
                                                <th>–†–æ–ª—å</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var user in partition.Users)
                                            {
                                                <tr>
                                                    <td><code>@user.Id</code></td>
                                                    <td class="text-truncate" style="max-width: 180px;"
                                                        title="@user.Email">@user.Email</td>
                                                    <td>
                                                        <span
                                                            class="badge bg-@GetRoleBadgeColor(user.Role)">@user.Role</span>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted text-center mt-3">
                                        <em>–ü—É—Å—Ç–æ</em>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_lastResult))
{
    <details class="mb-3">
        <summary class="btn btn-sm btn-outline-secondary">üìã JSON-–æ—Ç–≤–µ—Ç</summary>
        <div class="card mt-2">
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">@_lastResult</pre>
            </div>
        </div>
    </details>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger mt-3">@_errorMessage</div>
}

@code {

    private static string GetRoleBadgeColor(string role)
    {
        return role switch
        {
            "admin" => "danger",
            "super_admin" => "dark",
            "tutor" => "info",
            _ => "secondary",
        };
    }

}
