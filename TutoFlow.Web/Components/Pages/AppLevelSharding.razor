@page "/sharding/app-level"
@using System.Globalization
@rendermode InteractiveServer

@inject ShardingApiClient ShardingApi

<PageTitle>Application-Level Sharding</PageTitle>

<h1>Demo 2: Application-Level Sharding</h1>

<p>
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —à–∞—Ä–¥–∏–Ω–≥–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ PostgreSQL (<code>shard-dunduk</code>, <code>shard-funduk</code>).
    <code>ShardManager</code> –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–Ω—Ç—Ä—ã –ø–æ —Ö–µ—à—É –∏–º–µ–Ω–∏: <code>hash(name) % 2</code>.
</p>


<div class="mb-3">
    <div class="btn-group" role="group">
        <button class="btn btn-primary" @onclick="InitAsync" disabled="@_isLoading">
            üèóÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∞—Ä–¥—ã
        </button>
        <button class="btn btn-success" @onclick="SeedAsync" disabled="@_isLoading">
            üå± –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä—ã (@_seedCount —à—Ç.)
        </button>
        <button class="btn btn-info" @onclick="GetStatsAsync" disabled="@_isLoading">
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button class="btn btn-danger" @onclick="ResetAsync" disabled="@_isLoading">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
        </button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-auto">
        <label for="seedCount" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–Ω—Ç—Ä–æ–≤:</label>
        <input id="seedCount" type="number" class="form-control" style="max-width: 200px" @bind="_seedCount" min="1"
               max="100" />
    </div>
    <div class="col-auto">
        <label for="queryName" class="form-label">–ò–º—è —Ü–µ–Ω—Ç—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
        <div class="input-group" style="max-width: 400px">
            <input id="queryName" type="text" class="form-control" @bind="_queryCenterName"
                   placeholder="–¶–µ–Ω—Ç—Ä ¬´–≠—Ä—É–¥–∏—Ç¬ª #1" />
            <button class="btn btn-outline-primary" @onclick="QueryCenterAsync" disabled="@_isLoading">
                üîç –ù–∞–π—Ç–∏
            </button>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—Ç—Ä –≤—Ä—É—á–Ω—É—é</strong>
    </div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="addName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input id="addName" type="text" class="form-control" style="max-width: 300px"
                       @bind="_addName" placeholder="–¶–µ–Ω—Ç—Ä ¬´–≠—Ä—É–¥–∏—Ç¬ª" />
            </div>
            <div class="col-auto">
                <label for="addAddress" class="form-label">–ê–¥—Ä–µ—Å:</label>
                <input id="addAddress" type="text" class="form-control" style="max-width: 300px"
                       @bind="_addAddress" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è" />
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-success" @onclick="AddCenterAsync" disabled="@_isLoading">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button class="btn btn-outline-secondary" @onclick="FillRandomCenter" disabled="@_isLoading">
                    üé≤ –°–ª—É—á–∞–π–Ω—ã–µ
                </button>
            </div>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
}

@if (_shardData is not null && _shardData.Shards.Count > 0)
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>üóÑÔ∏è –†–∞–∑–º–µ—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞—Ä–¥–∞–º</strong>
            <span class="badge bg-secondary">–í—Å–µ–≥–æ: @_shardData.TotalCenters —Ü–µ–Ω—Ç—Ä–æ–≤</span>
        </div>
        <div class="card-body">
            <div class="row">
                @{
                    var colors = new[] { "primary", "success" };
                    var icons = new[] { "üü¶", "üü©" };
                }
                @foreach (var (shard, index) in _shardData.Shards.Select((s, i) => (s, i)))
                {
                    var color = colors[index % colors.Length];
                    var icon = icons[index % icons.Length];
                    var percentage = _shardData.TotalCenters > 0
                        ? (double)shard.RowCount / _shardData.TotalCenters * 100
                        : 0;

                    <div class="col-md-6 mb-3">
                        <div class="card border-@color h-100">
                            <div
                                class="card-header bg-@color bg-opacity-10 d-flex justify-content-between align-items-center">
                                <strong>@icon @shard.ShardName</strong>
                                <span class="badge bg-@color">@shard.RowCount —Ü–µ–Ω—Ç—Ä–æ–≤</span>
                            </div>
                            <div class="card-body p-2">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-@color" role="progressbar"
                                         style="width: @percentage.ToString("F1", CultureInfo.InvariantCulture)%"
                                         aria-valuenow="@shard.RowCount" aria-valuemin="0"
                                         aria-valuemax="@_shardData.TotalCenters">
                                    </div>
                                </div>
                                <small class="text-muted">@percentage.ToString("F1")% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞</small>

                                @if (shard.Centers.Count > 0)
                                {
                                    <div class="table-responsive mt-2" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                <th>–ê–¥—Ä–µ—Å</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var center in shard.Centers)
                                            {
                                                <tr>
                                                    <td><code>@center.Id</code></td>
                                                    <td>@center.Name</td>
                                                    <td class="text-muted">@(center.Address ?? "‚Äî")</td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted text-center mt-3">
                                        <em>–ü—É—Å—Ç–æ</em>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_lastResult))
{
    <details class="mb-3">
        <summary class="btn btn-sm btn-outline-secondary">üìã JSON-–æ—Ç–≤–µ—Ç</summary>
        <div class="card mt-2">
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">@_lastResult</pre>
            </div>
        </div>
    </details>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger mt-3">@_errorMessage</div>
}
