@page "/sharding/interceptor"
@rendermode InteractiveServer

@inject ShardingApiClient ShardingApi

<PageTitle>EF Core Interceptor Sharding</PageTitle>

<h1>Demo 3: EF Core Interceptor-Based Sharding</h1>

<p>
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —à–∞—Ä–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ <code>DbCommandInterceptor</code>.
    –î–≤–µ —Å—Ö–µ–º—ã (<code>shard_a</code>, <code>shard_b</code>) –≤ –æ–¥–Ω–æ–π –ë–î.
    Interceptor –ø–æ–¥–º–µ–Ω—è–µ—Ç –∏–º—è —Å—Ö–µ–º—ã –≤ SQL-–∫–æ–º–∞–Ω–¥–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ <code>AsyncLocal&lt;string&gt;</code>.
    –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ <code>client_profile_id</code>: —á—ë—Ç–Ω—ã–µ ‚Üí shard_a, –Ω–µ—á—ë—Ç–Ω—ã–µ ‚Üí shard_b.
</p>

<div class="mb-3">
    <div class="btn-group" role="group">
        <button class="btn btn-primary" @onclick="InitAsync" disabled="@_isLoading">
            üèóÔ∏è –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã
        </button>
        <button class="btn btn-success" @onclick="SeedAsync" disabled="@_isLoading">
            üå± –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (@_seedCount —à—Ç.)
        </button>
        <button class="btn btn-info" @onclick="GetStatsAsync" disabled="@_isLoading">
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button class="btn btn-danger" @onclick="ResetAsync" disabled="@_isLoading">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—ã
        </button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-auto">
        <label for="seedCount" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</label>
        <input id="seedCount" type="number" class="form-control" style="max-width: 200px" @bind="_seedCount" min="1"
               max="200" />
    </div>
    <div class="col-auto">
        <label for="queryId" class="form-label">client_profile_id –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
        <div class="input-group" style="max-width: 300px">
            <input id="queryId" type="number" class="form-control" @bind="_queryClientProfileId" min="1" />
            <button class="btn btn-outline-primary" @onclick="QueryStudentAsync" disabled="@_isLoading">
                üîç –ù–∞–π—Ç–∏
            </button>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é</strong>
    </div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="addName" class="form-label">–§–ò–û:</label>
                <input id="addName" type="text" class="form-control" style="max-width: 250px"
                       @bind="_addFullName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
            </div>
            <div class="col-auto">
                <label for="addClientProfileId" class="form-label">client_profile_id:</label>
                <input id="addClientProfileId" type="number" class="form-control" style="max-width: 150px"
                       @bind="_addClientProfileId" min="1" />
            </div>
            <div class="col-auto">
                <label for="addGrade" class="form-label">–ö–ª–∞—Å—Å (1-12):</label>
                <input id="addGrade" type="number" class="form-control" style="max-width: 120px"
                       @bind="_addGrade" min="1" max="12" />
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-success" @onclick="AddStudentAsync" disabled="@_isLoading">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
        <small class="text-muted mt-1 d-block">
            –®–∞—Ä–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ client_profile_id: —á—ë—Ç–Ω—ã–µ ‚Üí shard_a, –Ω–µ—á—ë—Ç–Ω—ã–µ ‚Üí shard_b
        </small>
    </div>
</div>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
}

@if (!string.IsNullOrEmpty(_lastResult))
{
    <div class="card mt-3">
        <div class="card-header">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç</strong>
        </div>
        <div class="card-body">
            <pre class="mb-0" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">@_lastResult</pre>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger mt-3">@_errorMessage</div>
}
