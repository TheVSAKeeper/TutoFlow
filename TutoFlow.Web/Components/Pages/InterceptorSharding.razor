@page "/sharding/interceptor"
@using System.Globalization
@rendermode InteractiveServer

@inject ShardingApiClient ShardingApi

<PageTitle>EF Core Interceptor Sharding</PageTitle>

<h1>Demo 3: EF Core Interceptor-Based Sharding</h1>

<p>
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —à–∞—Ä–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ <code>DbCommandInterceptor</code>.
    –î–≤–µ —Å—Ö–µ–º—ã (<code>shard_a</code>, <code>shard_b</code>) –≤ –æ–¥–Ω–æ–π –ë–î.
    Interceptor –ø–æ–¥–º–µ–Ω—è–µ—Ç –∏–º—è —Å—Ö–µ–º—ã –≤ SQL-–∫–æ–º–∞–Ω–¥–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ <code>AsyncLocal&lt;string&gt;</code>.
    –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ <code>client_profile_id</code>: —á—ë—Ç–Ω—ã–µ ‚Üí shard_a, –Ω–µ—á—ë—Ç–Ω—ã–µ ‚Üí shard_b.
</p>

<div class="mb-3">
    <div class="btn-group" role="group">
        <button class="btn btn-primary" @onclick="InitAsync" disabled="@_isLoading">
            üèóÔ∏è –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã
        </button>
        <button class="btn btn-success" @onclick="SeedAsync" disabled="@_isLoading">
            üå± –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (@_seedCount —à—Ç.)
        </button>
        <button class="btn btn-info" @onclick="GetStatsAsync" disabled="@_isLoading">
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button class="btn btn-danger" @onclick="ResetAsync" disabled="@_isLoading">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—ã
        </button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-auto">
        <label for="seedCount" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</label>
        <input id="seedCount" type="number" class="form-control" style="max-width: 200px" @bind="_seedCount" min="1"
               max="200" />
    </div>
    <div class="col-auto">
        <label for="queryId" class="form-label">client_profile_id –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
        <div class="input-group" style="max-width: 300px">
            <input id="queryId" type="number" class="form-control" @bind="_queryClientProfileId" min="1" />
            <button class="btn btn-outline-primary" @onclick="QueryStudentAsync" disabled="@_isLoading">
                üîç –ù–∞–π—Ç–∏
            </button>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é</strong>
    </div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="addName" class="form-label">–§–ò–û:</label>
                <input id="addName" type="text" class="form-control" style="max-width: 250px"
                       @bind="_addFullName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
            </div>
            <div class="col-auto">
                <label for="addClientProfileId" class="form-label">client_profile_id:</label>
                <input id="addClientProfileId" type="number" class="form-control" style="max-width: 150px"
                       @bind="_addClientProfileId" min="1" />
            </div>
            <div class="col-auto">
                <label for="addGrade" class="form-label">–ö–ª–∞—Å—Å (1-12):</label>
                <input id="addGrade" type="number" class="form-control" style="max-width: 120px"
                       @bind="_addGrade" min="1" max="12" />
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-success" @onclick="AddStudentAsync" disabled="@_isLoading">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button class="btn btn-outline-secondary" @onclick="FillRandomStudent" disabled="@_isLoading">
                    üé≤ –°–ª—É—á–∞–π–Ω—ã–µ
                </button>
            </div>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
}

@if (_shardData is not null && _shardData.Schemas.Count > 0)
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>üóÑÔ∏è –†–∞–∑–º–µ—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ö–µ–º–∞–º</strong>
            <span class="badge bg-secondary">–í—Å–µ–≥–æ: @_shardData.TotalStudents —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
        </div>
        <div class="card-body">
            <div class="row">
                @{
                    var colors = new[] { "primary", "success" };
                    var icons = new[] { "üîµ", "üü¢" };
                }
                @foreach (var (schema, index) in _shardData.Schemas.Select((s, i) => (s, i)))
                {
                    var color = colors[index % colors.Length];
                    var icon = icons[index % icons.Length];
                    var percentage = _shardData.TotalStudents > 0
                        ? (double)schema.RowCount / _shardData.TotalStudents * 100
                        : 0;

                    var rule = index == 0 ? "—á—ë—Ç–Ω—ã–µ client_profile_id" : "–Ω–µ—á—ë—Ç–Ω—ã–µ client_profile_id";

                    <div class="col-md-6 mb-3">
                        <div class="card border-@color h-100">
                            <div class="card-header bg-@color bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>@icon @schema.SchemaName</strong>
                                    <span class="badge bg-@color">@schema.RowCount —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
                                </div>
                                <small class="text-muted">–ü—Ä–∞–≤–∏–ª–æ: @rule</small>
                            </div>
                            <div class="card-body p-2">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-@color" role="progressbar"
                                         style="width: @percentage.ToString("F1", CultureInfo.InvariantCulture)%"
                                         aria-valuenow="@schema.RowCount" aria-valuemin="0"
                                         aria-valuemax="@_shardData.TotalStudents">
                                    </div>
                                </div>
                                <small class="text-muted">@percentage.ToString("F1")% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞</small>

                                @if (schema.Students.Count > 0)
                                {
                                    <div class="table-responsive mt-2" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>–§–ò–û</th>
                                                <th>–ö–ª–∞—Å—Å</th>
                                                <th>ProfileID</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var student in schema.Students)
                                            {
                                                <tr>
                                                    <td><code>@student.Id</code></td>
                                                    <td>@student.FullName</td>
                                                    <td>
                                                        @if (student.Grade.HasValue)
                                                        {
                                                            <span
                                                                class="badge text-dark bg-light border">@student.Grade</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">‚Äî</span>
                                                        }
                                                    </td>
                                                    <td><code>@student.ClientProfileId</code></td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted text-center mt-3">
                                        <em>–ü—É—Å—Ç–æ</em>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_lastResult))
{
    <details class="mb-3">
        <summary class="btn btn-sm btn-outline-secondary">üìã JSON-–æ—Ç–≤–µ—Ç</summary>
        <div class="card mt-2">
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">@_lastResult</pre>
            </div>
        </div>
    </details>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger mt-3">@_errorMessage</div>
}
